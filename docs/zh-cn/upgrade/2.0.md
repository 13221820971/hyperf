# 2.0 升级指南

## 升级 Swoole 到 4.5+

2.0 版将最低的 Swoole 版本要求从 4.4+ 提升到了 4.5+，这两个版本之间有一些使用上的细节问题，Hyperf 已经在较早的版本便已适配了，对于 Hyperf 的用户而言无需理会这之间的差异，我们提升最低 Swoole 版本要求主要是为了减少我们的历史负担。   

## 添加 ClassLoader 初始化

在 `bin/hyperf.php` 脚本中，添加代码 `Hyperf\Di\ClassLoader::init();`. 详情见以下代码。

```php
<?php

ini_set('display_errors', 'on');
ini_set('display_startup_errors', 'on');

error_reporting(E_ALL);
date_default_timezone_set('Asia/Shanghai');

! defined('BASE_PATH') && define('BASE_PATH', dirname(__DIR__, 1));
! defined('SWOOLE_HOOK_FLAGS') && define('SWOOLE_HOOK_FLAGS', SWOOLE_HOOK_ALL);

require BASE_PATH . '/vendor/autoload.php';

Hyperf\Di\ClassLoader::init();

// Self-called anonymous function that creates its own scope and keep the global namespace clean.
(function () {
    /** @var \Psr\Container\ContainerInterface $container */
    $container = require BASE_PATH . '/config/container.php';

    $application = $container->get(\Hyperf\Contract\ApplicationInterface::class);
    $application->run();
})();

```

`tests/bootstrap.php` 中也需要修改

```php
<?php

declare(strict_types=1);

error_reporting(E_ALL);
date_default_timezone_set('Asia/Shanghai');

! defined('BASE_PATH') && define('BASE_PATH', dirname(__DIR__, 1));
! defined('SWOOLE_HOOK_FLAGS') && define('SWOOLE_HOOK_FLAGS', SWOOLE_HOOK_ALL);

Swoole\Runtime::enableCoroutine(true);

require BASE_PATH . '/vendor/autoload.php';

Hyperf\Di\ClassLoader::init();

$container = require BASE_PATH . '/config/container.php';

$container->get(Hyperf\Contract\ApplicationInterface::class);

```

## 调整 `Dockerfile` 和 `composer.json`

因为 2.0 去掉了 `init-proxy.sh` 脚本，所以需要从 `composer.json` 中去掉对应的脚本，并修改 `post-autoload-dump` 为删除 `runtime/container` 目录。

```json
{
    "scripts": {
        "post-root-package-install": [
            "@php -r \"file_exists('.env') || copy('.env.example', '.env');\""
        ],
        "post-autoload-dump": [
            "rm -rf runtime/container"
        ],
        "analyse": "phpstan analyse --memory-limit 300M -l 0 -c phpstan.neon ./app ./config",
        "cs-fix": "php-cs-fixer fix $1",
        "start": "php ./bin/hyperf.php start",
        "test": "co-phpunit -c phpunit.xml --colors=always"
    }
}

```

接下来需要修改对应的 `Dockerfile`，以下忽略其他未修改的地方。

打包过程中，主动执行 `php bin/hyperf.php` 会帮助创建所有需要生成的代理类和扫描缓存，会极大的优化线上项目启动的时间。

```dockerfile
ENV TIMEZONE=${timezone:-"Asia/Shanghai"} \
    APP_ENV=prod \
    SCAN_CACHEABLE=(true)

COPY . /opt/www
RUN composer install --no-dev -o && php bin/hyperf.php

EXPOSE 9501

ENTRYPOINT ["php", "/opt/www/bin/hyperf.php", "start"]
```

当然，非 `Docker` 部署的用户，需要注意这里，重新启动前，最好先执行 `php bin/hyperf.php`，然后再关掉服务并重新启动。

## 调整配置

配置文件中，添加两个配置

```php
<?php

return [
    'app_name' => env('APP_NAME', 'skeleton'),
    'app_env' => env('APP_ENV', 'dev'),
    'scan_cacheable' => env('SCAN_CACHEABLE', false),
];
```

`scan_cacheable` 用于是否使用扫描缓存，以上 `Dockerfile` 和 `config/config.php` 中都有相关修改。当开启这个配置后，项目启动时会认为所有类都已扫描，
并正确生成了对应的缓存和代理。所以会跳过扫描阶段，优化启动时间，并不会初始化 `BetterReflection`，减少内存开销。

## 修改 `config/autoload/logger.php`

因为提高了 Mongolog 的版本，而在高版本的组件中，默认的日志格式化被修改，如果有这方面的需求，比如需要匹配日志规则，进行日志收集这种情况，建议修改对应配置 `dateFormat`。

```php
<?php

declare(strict_types=1);

return [
    'default' => [
        'handler' => [
            'class' => Monolog\Handler\StreamHandler::class,
            'constructor' => [
                'stream' => BASE_PATH . '/runtime/logs/hyperf.log',
                'level' => Monolog\Logger::DEBUG,
            ],
        ],
        'formatter' => [
            'class' => Monolog\Formatter\LineFormatter::class,
            'constructor' => [
                'format' => null,
                'dateFormat' => 'Y-m-d H:i:s',
                'allowInlineLineBreaks' => true,
            ],
        ],
        'processors' => [
        ],
    ],
];

```

## 修改 `config/autoload/exceptions.php`

2.0 版本添加了一套 `HttpException`，如果用户抛出对应的异常，可以同步修改对应的 `http status code`，所以需要添加对应的异常捕获器

```php
<?php

declare(strict_types=1);

return [
    'handler' => [
        'http' => [
            Hyperf\HttpServer\Exception\Handler\HttpExceptionHandler::class,
            ...
        ],
    ],
];

```
